import requests
import numpy as np
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.neural_network import MLPClassifier

# --- ১. HubSpot কনফিগারেশন ---
ACCESS_TOKEN = "আপনার_টোকেন_এখানে"
headers = {
    'Authorization': f'Bearer {ACCESS_TOKEN}',
    'Content-Type': 'application/json'
}

# --- ২. AI ট্রেনিং ডাটা (German SMEs-এর জন্য) ---
# আপনার আগের সেই JSON স্টাইল এখানে আমরা হার্ডকোড করছি
sentences = [
    "Wo ist meine Rechnung?", "Ich habe die Rechnung nicht erhalten", # Billing
    "Das System funktioniert nicht", "Ich brauche technische Hilfe",  # Support
    "Ich möchte einen Termin vereinbaren", "Wann habt ihr Zeit?"       # Appointment
]
labels = ["Rechnung", "Rechnung", "Support", "Support", "Termin", "Termin"]

# ভেক্টরাইজেশন (আপনার চেনা TF-IDF)
vectorizer = TfidfVectorizer()
X = vectorizer.fit_transform(sentences)

# মডেল ট্রেনিং (আপনার প্রিয় MLP)
model = MLPClassifier(hidden_layer_sizes=(16, 8), max_iter=1000)
model.fit(X, labels)

def predict_intent(text):
    x_test = vectorizer.transform([text])
    # কনফিডেন্স চেক (threshold > 0.3 লজিক)
    probs = model.predict_proba(x_test)
    if np.max(probs) > 0.3:
        return model.predict(x_test)[0]
    return "Unknown"

# --- ৩. CRM ইন্টিগ্রেশন লজিক ---
def run_ai_automation():
    # কাস্টমার ডাটা আনা
    url = "https://api.hubapi.com/crm/v3/objects/contacts?properties=firstname,message_body"
    response = requests.get(url, headers=headers)
    
    if response.status_code == 200:
        contacts = response.json().get('results', [])
        for contact in contacts:
            contact_id = contact['id']
            name = contact['properties'].get('firstname', 'Customer')
            msg = contact['properties'].get('message_body', '')

            if msg:
                # এআই দিয়ে প্রেডিক্ট করা
                intent = predict_intent(msg)
                print(f"Customer: {name}, Intent: {intent}")

                # HubSpot-এ নোট পাঠানো (অটোমেশন)
                note_url = "https://api.hubapi.com/crm/v3/objects/notes"
                note_data = {
                    "properties": {
                        "hs_note_body": f"AI Insight: This is a {intent} query.",
                        "hs_timestamp": "2026-01-20T00:00:00Z"
                    },
                    "associations": [{"to": {"id": contact_id}, "types": [{"associationCategory": "HUBSPOT_DEFINED", "associationTypeId": 202}]}]
                }
                requests.post(note_url, headers=headers, json=note_data)
                print(f"Successfully updated CRM for {name}")

# অটোমেশন রান করুন
run_ai_automation()
